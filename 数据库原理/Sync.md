## 数据库的乐观锁和悲观锁

#### 悲观锁(悲观并发控制)

悲观锁,正如其名,它指的是对数据被外界(包括本系统当前的其他事务,以及来自外部系统的事务处理)修改持保守态度(悲观),因此,在整个数据处理过程中,将数据处于锁定状态.悲观锁的实现,往往依靠数据库提供的锁机制(也只有数据库提供的锁机制才能真正保证数据访问的排他性,否则,及时在本系统中实现了加锁机制,也无法保证外部系统不会修改数据)

###### 在数据库中,悲观锁的流程如下:

在对任意记录进行修改前,先尝试为该记录加上排他锁.如果加锁失败,说明该记录正在被修改,那么当前查询可能要等待或者抛出异常.具体响应方式由开发者根据实际需要决定.

如果成功加锁,那么就可以对记录做修改,事务完成后就会解锁了.

期间如果有其他对该记录做修改或加排他锁的操作,都会等待我们解锁或直接抛出异常.



#### 乐观锁(乐观并发控制)

乐观锁相对悲观锁而言,乐观锁假设认为数据一般情况下不会造成冲突,所以在数据进行提交更新的时候,才会正式对数据的冲突与否进行检测,如果发现冲突了,则让返回用户错误的信息,让用户决定如何去做.

相对于悲观锁,在对数据库进行处理的时候,乐观锁并不会使用数据库提供的锁机制.一般的实现乐观锁的方式就是记录数据版本.

###### 优点和不足

乐观并发控制相信事物之间的数据竞争的概率是比较小的,因此尽可能直接做下去,直到提交的时候才去锁定,所以不会产生任何锁和死锁.但如果直接简单这么做,还是有可能会遇到不可预期的结果,例如两个事务都读取了数据库的某一行,经过修改以后写会数据库,这时就遇到了问题.